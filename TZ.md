# 1) Архитектура

* **TG-бот (aiogram 3.x)**
  Роутеры по ролям (агент/РОП/юрист), FSM для анкет/загрузок, inline-клавиатуры.
* **Сервис документов**
  `python-docx` для протокола, валидация форматов, хэширование и метаданные.
* **Интеграция Яндекс.Диска**
  REST API + OAuth токен (прикладной токен сервиса). Создание папок, загрузка, публичные ссылки, (опционально) перемещение в архив.
* **БД (SQLite)**
  Пользователи/роли, заявки, ответы анкеты, документы, задачи, статусы, история.
* **Логи и аудит**
  Ошибки (RotatingFileHandler), события статусов, кто/когда сделал действие.

# 2) Роли и доступ

* **Агент**: создаёт/редактирует заявку, проходит анкету, грузит файлы, дорабатывает. Видит свои заявки.
* **РОП**: видит заявки своего отдела, одобряет → юристу, либо возвращает с комментарием.
* **Юрист**: видит переданные заявки, ставит задачи агенту, открывает папку/протокол, закрывает сделку.
* **Админ (служебно)**: присвоение ролей и отделов, настройка списков.

# 3) Сквозной бизнес-процесс

1. **Регистрация** (первый запуск): бот спрашивает ФИО и № отдела → назначает роль (по предзагруженному списку/вручную админ-командой).
2. **Создание заявки (Агент)**

   * Ввод полей: Тип сделки, № договора, дата подачи протокола, адрес, тип объекта, ФИО РОПа, ФИО сотрудника (по умолчанию — текущий агент, можно править).
   * **Анкета (16 вопросов)**: да/нет/имеется/отсутствует — сохраняется в БД.
   * **Загрузка документов**: Паспорт(ы), ЕГРН/правоустанавливающие, прочее. Можно многократно.
   * **Генерация протокола .docx** из шаблона → локально и в Я.Диск.
   * **Создание папки на Я.Диске** `ФИО_YYYY-MM-DD_Адрес` → загрузка всех файлов → получение публичной ссылки.
   * Статус: `CREATED`.
3. **Проверка РОПом**

   * РОП получает карточку + кнопку «Открыть протокол», «Открыть папку», «Одобрить → юристу», «Вернуть с комментарием».
   * При возврате → агенту уходит уведомление и комментарий. Статус: `RETURNED_ROP`.
   * При одобрении → юристу. Статус: `TO_LAWYER`.
4. **Проверка юристом**

   * Кнопки: «Поставить задачу агенту (текст)», «Открыть папку», «Открыть протокол», «Закрыть сделку».
   * При задаче → агенту пуш с текстом и кнопкой «Загрузить недостающее». Статус: `LAWYER_TASK`.
   * После дозагрузки → уведомление юристу.
   * «Закрыть сделку» → статус `CLOSED`, перемещение папки в архив (если включено).
5. **Повторные загрузки**

   * Агент может дозаливать документы в рамках открытой заявки в любой момент до `CLOSED`.

# 4) Состояния FSM (пример)

* `Reg: ask_fullname -> ask_department -> done`
* `CreateDeal: type -> contract_no -> protocol_date -> address -> object_type -> head_name -> agent_name -> questionnaire[q1..q16] -> confirm -> uploading -> generate_docx -> upload_to_disk -> ready`
* `ROPReview: view -> approve_to_lawyer | return_with_comment`
* `LawyerReview: view -> create_task | close_deal | wait_for_uploads`
* `AgentReupload: wait_files -> notify_lawyer`

# 5) Статусы заявки (enum)

`CREATED`, `RETURNED_ROP`, `TO_LAWYER`, `LAWYER_TASK`, `READY_FOR_REVIEW`, `CLOSED`, `CANCELLED`

# 6) БД-схема (SQLite)

**users**

* id PK, telegram\_id UNIQUE, full\_name, department\_no, role (agent/rop/lawyer/admin), is\_active, created\_at

**applications**

* id PK, agent\_id FK(users), rop\_id FK(users, nullable), lawyer\_id FK(users, nullable),
  deal\_type (purchase/sale/alt/legal), contract\_no, protocol\_date (date),
  address, object\_type, head\_name, agent\_name, yandex\_folder, yandex\_public\_url,
  status, created\_at, updated\_at

**questionnaire\_answers**

* id PK, application\_id FK, question\_key, answer\_value, created\_at

**documents**

* id PK, application\_id FK, doc\_type (passport/egrn/other), file\_name,
  local\_path, yandex\_path, sha256, uploaded\_at

**tasks**

* id PK, application\_id FK, author\_id FK(users), assignee\_id FK(users), text, status (open/closed), created\_at, closed\_at

**status\_history**

* id PK, application\_id FK, from\_status, to\_status, actor\_id FK(users), comment, changed\_at

**audit\_log**

* id PK, actor\_id, action, entity\_type, entity\_id, payload\_json, created\_at

# 7) Интеграция Яндекс.Диска

* OAuth токен приложения хранить в `.env` (или KMS).
* Папка: `/{env}/Сделки/{YYYY}/{MM}/{ФИО_YYYY-MM-DD_Адрес}` (убрать запрещённые символы).
* Методы: `create_folder`, `upload_file(stream|path, remote_path)`, `publish_path -> public_url`, `move_to_archive(app_id)`.
* Ретраи: экспоненциальные, обработка 429/5xx, контроль квот.
* Публичная ссылка хранится в `applications.yandex_public_url`.

# 8) Генерация Word-протокола

* Библиотека: `python-docx` (+ `docxtpl` удобно)
* Шаблон: `${deal_type}`, `${contract_no}`, `${protocol_date}`, `${address}`, `${object_type}`, `${head_name}`, `${agent_name}`, и блок таблицы для 16 ответов.
* Именование файла: `Протокол_{contract_no}_{YYYYMMDD}.docx`
* Локально: `./data/{app_id}/protocol.docx` → затем в Я.Диск.
* Регенирация при изменении анкеты/полей: кнопка «Пересобрать протокол».

# 9) Бот: структура проекта

```
app/
  main.py
  config.py
  keyboards/
  routers/
    common.py
    agent.py
    rop.py
    lawyer.py
    admin.py
  services/
    yandex_disk.py
    docgen.py
    storage.py
    notifier.py
  db/
    models.py
    repository.py
    migrations/ (alembic опционально)
  utils/
    validators.py
    security.py
  templates/
    protocol_template.docx
```

* **Middlewares**: auth (подтягивает user по telegram\_id), role-guard, throttling.
* **Storage FSM**: SQLite/Redis (для надёжности можно Redis, но MVP — Memory/SQLite).
* **Keyboards**: inline для статусов, выбора типа сделки, тип объекта, подтверждений.
* **Валидации**: обязательные поля; даты; типы файлов (pdf/jpg/png/doc/docx), лимиты размера.

# 10) Сообщения и UX (кратко)

* Агент: «Создать заявку», «Мои заявки», «Продолжить заполнение», «Загрузить документ», «Пересобрать протокол».
* РОП: «К проверке», карточка с данными + кнопки «Открыть протокол», «Папка на Диске», «Одобрить → юристу», «Вернуть (ввести комментарий)».
* Юрист: «К проверке», карточка + «Поставить задачу», «Открыть протокол», «Папка», «Закрыть сделку».
* Уведомления всем участникам при смене статуса/появлении задач/дозагрузке.

# 11) Безопасность и ПДн

* Минимизировать хранение ПДн локально: только метаданные и хэши; сами файлы — на Я.Диске.
* Ограничение доступа по ролям/отделу.
* Шифрование `.env`, разграничение прав в панели Я.Диска (сервисный токен).
* Санитизация имён файлов/папок, защита от path traversal.
* Логи без ПДн; отдельный защищённый аудит.

# 12) НФ-требования

* **Надёжность**: ретраи Я.Диска, «парк-и-повтори» задач (job queue простым cron/async-очередью).
* **Производительность**: ограничение размера файлов (напр. до 50–100 МБ/шт), асинхронная загрузка.
* **Доступность**: бот не должен падать при сбоях Диска — ставит задачку «дозалить позже».
* **Отказоустойчивость**: периодические бэкапы SQLite, экспорт CSV по заявкам.

# 13) Админ-функции

* `/add_user @username role=rop dept=12`
* `/set_role @username lawyer`
* `/list_users role=agent dept=7`
* Импорт CSV списка ролей.

# 14) MVP vs. расширения

**MVP** (2–3 недели):

* Регистрация, роли, создание заявки, анкета, загрузка, протокол, Я.Диск, статусы, проверки РОП/юрист, задачи, закрытие сделки, история статусов.

**Дальше**:

* Архивирование на Я.Диске, поиск по заявкам/фильтры, экспорт XLSX, напоминания (дежурные дедлайны), мульти-файл drag flow, автопроверки комплектности, S3-кэш (при необходимости), web-панель.

# 15) Пример клавиатур/флоу (суперкратко)

* Агент нажимает «Создать заявку» → последовательные вопросы (`ReplyKeyboard/Inline`) → после анкеты предложение «Загрузить паспорт/ЕГРН/Прочее» → «Сформировать протокол» → «Отправить РОП».
* РОП получает карточку с 4 кнопками.
* Юрист — аналогично, плюс «Поставить задачу».

# 16) Технологии и зависимости

* `aiogram>=3`, `python-dotenv`, `pydantic-settings`, `sqlalchemy` (или `sqlite3` + репозитории),
  `python-docx`/`docxtpl`, `requests`/`httpx` для Я.Диска, `loguru`/`logging`.

# 17) Соглашения по коду/неймингу

* Имена папок/файлов: латиница, без пробелов: `IvanovII_2025-08-08_Lenina10A`.
* Док-типы: `passport`, `egrn`, `other`.
* Вопросы анкеты — `q01..q16` с человекочитаемыми лейблами в справочнике.

# 18) План внедрения

1. Шаблон протокола + перечень 16 вопросов (финализировать).
2. Подготовить список пользователей/ролей/отделов.
3. Реализовать базовые роутеры и FSM.
4. Интеграция Я.Диска (создание папок, загрузка, публикация).
5. Генерация .docx.
6. РОП/Юрист-флоу, задачи, уведомления.
7. Логи, аудит, бэкапы.
8. UAT с 3–5 тестовыми кейсами, фиксы.
9. Прод.

---


План к релизу MVP
1) Технический долг по текущему коду (обязательно к релизу)
Инициализация БД: убедиться, что init_db() создаёт таблицы с учётом новых моделей (Task). Если БД уже есть — пересоздать для MVP или добавить миграцию.

Валидация входных данных в FSM:

дата протокола YYYY-MM-DD;

тип сделки/объекта из преднастроенных списков (или мягкая валидация + подсказка);

защита от пустых ответов в анкете.

Документы:

лимиты по размеру и допустимым типам (pdf/jpg/png/doc/docx), обработка ошибок скачивания;

нормализация имён файлов (латиница, без пробелов/спецсимволов);

вывод подтверждения и количества загруженных файлов.

Сброс состояний и UX:

после doc_done не просто сообщение, а карточка заявки с кратким резюме и подсказкой «РОП видит её в /rop».

Единообразные статусы:

мы используем CREATED → TO_LAWYER/RETURNED_ROP → LAWYER_TASK → CLOSED. Добавить промежуточный TO_ROP при желании — либо оставить текущую логику, где РОП смотрит CREATED (принять решение и зафиксировать в коде/README).

Отметки времени: обновлять updated_at на ключевых переходах.

Логи/ошибки: базовый logging/loguru + try/except в точках работы с файлами и БД.

2) Команды и карточки (довести до удобства)
/my: список «моих» заявок (для MVP без авторизации — показывать заявки, где creator_tg_id == from_user.id).

/app <id>: карточка заявки (ключевые поля, статус, количество загруженных документов).

Доработка по возврату РОП: сейчас комментарий ловим через /return <id> <комментарий>. Добавить минимальный FSM «введите комментарий» (мы уже сделали для РОПа — оставить и для юриста при постановке задач).

Повторная загрузка после задачи юриста:

кнопка «Загрузить дополнительные документы» в сообщении агенту → возвращает в тот же экран выбора типов доков для конкретной заявки.

после дозагрузки — нотификация юристу «Docs updated for app #ID».

3) Нотификации
Агенту:

при возврате РОПом (с комментом),

при одобрении РОПом → юристу,

при постановке задачи юристом (текст задачи),

при закрытии сделки.

(Можно оставить в MVP простые send_message по creator_tg_id; позже — вынести в notifier).

4) Мини-интеграция с Яндекс.Диском (если нужна в MVP)
Вы просили пока без протокола; про Диск вы не настаивали прямо сейчас. Для релиза MVP можно остаться на локальном хранении, но если нужна прямая выгрузка — минимум:

сервис YandexDiskClient с 3 методами: create_folder, upload_file, publish;

при завершении загрузки — создать папку ФИО_YYYY-MM-DD_Адрес, залить файлы, сохранить публичную ссылку в applications.yandex_public_url;

в карточках РОПа/юриста дать кнопку «Открыть папку» (просто отправить URL в чат).

5) Безопасность/ПДн (минимум для MVP)
Не логировать содержимое документов/ПДн.

Санитизация имён папок/файлов.

Токены в .env, .env в .gitignore.

Опционально: автозатирание локальных временных файлов после успешной загрузки на Диск (если включим Диск).

6) Деплой и окружение
Запуск: long polling (без webhooks) — проще для MVP.

Конфиг: .env с BOT_TOKEN, DATABASE_URL, ENV (dev/prod).

Сервис: systemd unit или Docker (на выбор). Для простоты — systemd.

Бэкап: nightly копия SQLite (tar.gz, дата в имени).

7) Тест-кейсы (чек-лист приемки)
Агент

Создание заявки, ответы на все 16 вопросов.

Загрузка 3 типов документов (фото и файл), проверка лимитов и ошибок.

Завершение загрузки → попадание в очередь РОПа.

Повторная загрузка после задачи юриста.

РОП

Просмотр /rop, карточки и действия.

Возврат с комментарием → уведомление агенту.

Одобрение → попадание в очередь юриста и уведомление агенту.

Юрист

Просмотр /lawyer, карточки и действия.

Постановка задачи → уведомление агенту; повторная загрузка → уведомление юристу (после доработки).

Закрытие сделки → уведомление агенту, статус CLOSED.

Общее

Конкурентные действия: два файла подряд; отправка некорректного формата; отмены/повторы.

Стабильность после рестарта бота (состояния не критичны, всё хранится в БД).

8) Документация
README: команды бота, сценарии для каждой роли, переменные .env, как сбросить/пересоздать БД.

Шаблоны сообщений: короткие тексты для уведомлений.

Словарь полей: список значений для типов сделок/объектов (на будущее — вынести в конфиг).

9) То, что можно оставить на пост-MVP
Генерация .docx-протокола (docxtpl).

Реестр заявок с фильтрами (внутренний admin-list).

Архивирование папок на Я.Диск.

Роли и полноценная авторизация/role-guard (сейчас упростили).

Автопроверка комплектности (чек-лист документов, подсветка недостающих).

